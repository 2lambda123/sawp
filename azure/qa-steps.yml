steps:
  # Check dependencies
  - script: echo "##vso[task.setvariable variable=PATH;]$PATH:$HOME/.cargo/bin"
    displayName: set path
  - script: cargo --version || curl https://sh.rustup.rs -sSf | sh -s -- -y
    displayName: install rust
  - script: rustup install 1.41.1
    displayName: install rust (msrv)
  - script: cargo tarpaulin --version || cargo install cargo-tarpaulin
    displayName: install cargo-tarpaulin
  - script: cbindgen --version || cargo install + cbindgen
    displayName: install cbindgen
  - script: cargo +nightly --version || rustup install nightly
    displayName: install rust nightly
  - script: cargo +nightly fuzz --version || cargo +nightly install cargo-fuzz
    displayName: install cargo-fuzz

  # Get the package version
  - script: echo "##vso[task.setvariable variable=version]$((test -f Cargo.lock || cargo generate-lockfile) && cargo pkgid | cut -d# -f 2)"
    displayName: package version

  # Check code formatting differences
  - script: cargo fmt --all -- --check
    displayName: check fmt
  
  # Build project
  # First, with the minimum supported rust version
  - script: cargo +1.41.1 build --workspace --all-targets --all-features --release
    displayName: build (msrv)
  # Then, with stable
  - script: cargo build --workspace --all-targets --all-features --release
    displayName: build
  
  # Check linting warnings
  - script: cargo clippy --workspace --all-targets --all-features -- -D warnings
    displayName: check clippy

  # Build documentation
  - script: cargo doc --workspace --all-features --no-deps
    displayName: cargo doc

  # Publish documentation
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: target/doc
      includeRootFolder: false
      archiveType: tar
      tarCompression: gz
      archiveFile: $(Build.ArtifactStagingDirectory)/sawp-$(version).tar.gz
      replaceExistingArchive: true

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(Build.ArtifactStagingDirectory)/sawp-$(version).tar.gz
      artifactName: sawp-$(version).tar.gz

  # Run the unit tests
  - script: cargo test --workspace --all-targets --all-features
    displayName: run tests

  # Build fuzz
  - script: cargo +nightly fuzz build
    displayName: build fuzz

  # Build headers
  - script: make headers
    displayName: build headers

  # Check code coverage
  - script: |
      OUTPUT=$(cargo tarpaulin -v --all --all-features --out Xml)
      echo "${OUTPUT}"

      if [[ $(echo "${OUTPUT}" | tail -1 | cut -d ' ' -f 1) < 75 ]]
      then
          echo "Coverage does not meet required percentage"
          exit 1
      fi
    displayName: check code coverage

  # Publish the code coverage reports
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: 'cobertura'
      summaryFileLocation: cobertura.xml
