steps:
  # Setup
  # ============
  # Configure environment
  #

  # Use cargo install path
  - script: echo "##vso[task.setvariable variable=PATH;]$PATH:/usr/local/cargo/bin"
    displayName: set path

  # Give builder access to cached rust install
  - script: sudo chown -R AzDevOps /usr/local/cargo /usr/local/rustup
    displayName: chown cargo dir
  
  # Get the package version
  - script: echo "##vso[task.setvariable variable=version]$(make version)"
    displayName: package version

  # QA Steps
  # ========
  #

  # Check code formatting differences
  - script: cargo fmt --all -- --check
    displayName: check fmt
  
  # Build project
  # First, with the minimum supported rust version
  - script: cargo +1.41.1 build --workspace --all-targets --all-features --release
    displayName: build (msrv)
  
  # Then, with stable
  - script: cargo build --workspace --all-targets --all-features --release
    displayName: build (stable)
  
  # Check linting warnings
  - script: cargo clippy --workspace --all-targets --all-features -- -D warnings
    displayName: check clippy

  # Build documentation
  - script: cargo doc --workspace --all-features --no-deps
    displayName: cargo doc

  # Publish documentation
  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: target/doc
      includeRootFolder: false
      archiveType: tar
      tarCompression: gz
      archiveFile: $(Build.ArtifactStagingDirectory)/sawp-doc-$(version).tar.gz
      replaceExistingArchive: true

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(Build.ArtifactStagingDirectory)/sawp-doc-$(version).tar.gz
      artifactName: sawp-$(version).tar.gz

  # Run the unit tests
  - script: cargo test --workspace --all-targets --all-features
    displayName: run tests
  
  # Run the memory checks
  - script: make memcheck
    displayName: memcheck

  # Run the doc tests
  # Needed until this issue is fixed: https://github.com/rust-lang/cargo/issues/6669
  - script: cargo test --workspace --doc --all-features
    displayName: run doc tests

  # Check code coverage
  - script: |
      OUTPUT=$(cargo tarpaulin -v --all --all-features --out Xml)
      echo "${OUTPUT}"

      if [[ $(echo "${OUTPUT}" | tail -1 | cut -d ' ' -f 1) < 75 ]]
      then
          echo "Coverage does not meet required percentage"
          exit 1
      fi
    displayName: check code coverage

  # Publish the code coverage reports
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: 'cobertura'
      summaryFileLocation: cobertura.xml

  # Check if cargo publish would pass
  - script: cargo publish --dry-run
    displayName: check publish
